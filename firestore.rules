rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    function isAdmin() {
      // Check if user is in 'admins' collection or has 'admin' role in their user profile
      return isAuthenticated() && (
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
      );
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated(); // Users can read other profiles (for names, etc.)
      allow create: if isUser(userId); // Users can create their own profile
      allow update: if isUser(userId) || isAdmin(); // Update own or admin
      allow delete: if isAdmin();
    }

    // Admins collection (Read-only for app logic, write only via Console)
    match /admins/{adminId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only manageable via Firebase Console
    }

    // SANGs collection
    match /sangs/{sangId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.organizerId == request.auth.uid || isAdmin()
      );
      allow delete: if isAdmin();

      // Members subcollection
      match /members/{memberId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (
          // User joining or updating their own status (if allowed logic exists)
          request.auth.uid == memberId || 
          // Organizer of the parent SANG
          get(/databases/$(database)/documents/sangs/$(sangId)).data.organizerId == request.auth.uid ||
          isAdmin()
        );
      }
    }
  }
}
